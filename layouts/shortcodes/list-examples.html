{{- $filters := split (.Get "filters") "," -}}

{{- $target := printf "%sexamples/" .Page.FirstSection.RelPermalink -}}
{{- $pages := (where .Site.Pages "Section" .Page.Section) -}}

{{- with .Get "directory" -}}
  {{- $target = . -}}
{{- end -}}

<!-- Build out the filters dynamically -->
{{ if ne (index $filters 0) "" }}
<div class="selectorDropdowns">
{{- range $index, $filter := $filters -}}

{{- $optionsArray := slice -}}
{{- range $index, $page := $pages.ByWeight -}}
{{- with (index $page.Params $filter) }}
{{- $optionsArray = $optionsArray | append . -}}
{{- end -}}
{{- end -}}

{{- $optionsArray = sort (uniq $optionsArray) -}}

<div>
  <label for="{{$filter}}">{{replace $filter "-" " " | title}}</label>
  <select class="selectorFilter" name="data-{{$filter}}" id="{{$filter}}">
      <option value="all">Select...</option>
      {{- range $optionsArray -}}
      <option value="{{.}}">{{.}}</option>
      {{- end -}}
  </select>
  </div>
{{- end -}}
</div>
{{ end }}

<!-- Add list of examples, with optional filterable properties -->
<ul class="DocsCodeExamplesOverview" style="list-style: none">
  {{- range $index, $page := $pages.ByWeight -}}
    {{- $x := $page.RelPermalink -}}
    {{- $isExample := (strings.HasPrefix $x $target) -}}
    {{- if and (ne $x $target) $isExample -}}
    <li class="DocsCodeExamplesOverview--example"
    {{ if ne (index $filters 0) "" }}
    {{ range $index2, $filter := $filters }}
    {{ with (index $page.Params $filter) }}
    data-{{$filter}}="{{ delimit (.) "|" }}"
    {{ end }}
    {{ end }}
    {{ end }}
    >
      <div class="DocsCodeExamplesOverview--example-title">
        {{- .Page.RenderString (printf "[%s](%s)" $page.Title $page.RelPermalink) -}}
      </div>

      <div class="DocsCodeExamplesOverview--example-description">
        {{ $page.Params.summary | .Page.RenderString }}
      </div>
    </li>
    {{- end -}}
  {{- end -}}
</ul>

<script>

function getSelectValues(selectElementCollection) {
  let selectedValues = {};
  for (const htmlElement of selectElementCollection) {
    let selectElement = htmlElement;
    let selectedValue =
      selectElement.options[selectElement.selectedIndex].value;
    if (selectedValue !== 'all') {
      selectedValues[selectElement.id] = selectedValue;
    }
  }
  return selectedValues;
}

const examples = document.getElementsByClassName("DocsCodeExamplesOverview--example")

const selectorDropdowns = document.getElementsByClassName("selectorFilter");
for (const dropdown of selectorDropdowns) {
  dropdown.addEventListener("change", () => {
    let selectedOptions = getSelectValues(selectorDropdowns);
    for (const example of examples) {

      let keepValue = true;
      for (option in selectedOptions) {

        if (!example.dataset[option] || !example.dataset[option].split("|").includes(selectedOptions[option])) {
          keepValue = false;
        }
      }
      if (keepValue) {
        console.log(example.firstElementChild.textContent)
        example.style.display = "";
      } else {
        example.style.display = "none";
      }
    }
  })
}


</script>